<% content_for :ruta_navegacion do %>
  <%= link_to "Inicio", root_path, class: "crumb-link" %>
  <span class="crumb-separator">‚ùØ</span>
  <%= link_to "Registro", new_registro_path, class: "crumb-link" %>
  <% if @registro %>
    <span class="crumb-separator">‚ùØ</span>
    <span class="crumb-current">Carrusel</span>
  <% end %>
<% end %>

<style>
  /* --- 1. ESTILOS DEL CARRUSEL --- */
  .carrusel-marco {
    width: 100%;
    max-width: 500px;
    height: 300px;
    margin: 0 auto 30px auto;
    overflow: hidden; /* IMPORTANTE: Oculta las fotos que "sobran" a los lados */
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    border: 4px solid #fff;
    position: relative;
    background: #000;
  }

  .carrusel-tira {
    display: flex; /* Pone las fotos una al lado de la otra */
    height: 100%;
    transition: transform 0.5s ease-in-out; /* Suaviza el movimiento */
    width: 100%;
  }

  .carrusel-item { 
    min-width: 100%; /* OBLIGATORIO: Cada foto ocupa el 100% del marco */
    flex-shrink: 0;  /* Evita que se aplasten */
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center; 
    position: relative;
  }
  
  .carrusel-item img { 
    width: 100%; 
    height: 100%; 
    object-fit: contain; /* Ajusta la imagen sin recortarla */
  }

  /* --- 2. ESTILOS DEL TICKET --- */
  .ticket-container {
    background-color: #fff;
    border: 2px dashed #333;
    width: 350px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Courier New', Courier, monospace;
    box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
  }
  .ticket-item { margin-bottom: 8px; font-size: 14px; display: flex; justify-content: space-between; }
  
  /* --- 3. BOTONES Y SUBIDA --- */
  .upload-area {
    max-width: 400px; margin: 30px auto; padding: 20px;
    background: #f0f4f8; border-radius: 10px; border: 2px dashed #cbd5e0;
    text-align: center;
  }
  .btn-subir {
    background: #28a745; color: white; border: none; padding: 10px 20px;
    border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px;
  }
</style>

<h1 style="text-align:center;">Bienvenido a Hola Mundo</h1>

<% if @registro %>

  <p style="text-align:center; color: #2c3e50;">‚úÖ Datos cargados correctamente.</p>
  <br><hr><br>

  <div class="carrusel-marco">
    <div class="carrusel-tira" id="tiraFotos">
      <% if @registro.fotos.attached? %>
        <% @registro.fotos.each do |foto| %>
          <div class="carrusel-item">
            <%= image_tag foto %>
          </div>
        <% end %>
      <% else %>
        <div class="carrusel-item">
          <span style="color: white; font-size: 1.2em;">üö´ Sin Evidencias</span>
        </div>
      <% end %>
    </div>
  </div>

  <div class="ticket-container">
    <div style="text-align: center; border-bottom: 2px solid #333; margin-bottom: 15px;">
      <h3>TICKET OFICIAL</h3>
      <small>ID: #<%= @registro.id %> | <%= Time.now.strftime("%d/%m/%Y") %></small>
    </div>

    <div class="ticket-item"><span>Nombre:</span> <strong><%= @registro.nombre %></strong></div>
    <div class="ticket-item"><span>Apellido:</span> <strong><%= @registro.apellido %></strong></div>
    <div class="ticket-item"><span>F. Nac:</span> <span><%= @registro.fecha_nacimiento %></span></div>
    <div class="ticket-item"><span>Email:</span> <small><%= @registro.email %></small></div>
    <div class="ticket-item"><span>Tel:</span> <span><%= @registro.telefono %></span></div>

    <div style="text-align: center; margin-top: 20px;">**********************</div>
    <div style="text-align: center; font-size: 0.8em; color: #666;">
      Fotos totales: <%= @registro.fotos.count %>
    </div>
  </div>

  <div class="upload-area">
    <h3 style="margin-top:0;">üì∏ Agregar Evidencia</h3>
    
    <% if flash[:alert] %>
      <div style="background-color: #ffe6e6; color: #cc0000; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-weight: bold;">
        <%= flash[:alert] %>
      </div>
    <% end %>

    <%= form_with model: @registro, url: registro_path(@registro), method: :patch, local: true do |form| %>
      <div style="margin-bottom: 10px;">
        <%= form.file_field :fotos, class: "form-control", accept: 'image/png,image/jpg,image/jpeg,image/gif,image/webp' %>
      </div>
      <%= form.submit "Subir Foto", class: "btn-subir" %>
    <% end %>
  </div>

  <div style="text-align: center; margin-bottom: 50px;">
    <%= link_to "Salir / Nuevo Registro", root_path, style: "color: #e53e3e;" %>
  </div>

  <script>
    function iniciarCarrusel() {
      const tira = document.getElementById('tiraFotos');
      
      // Si no existe el carrusel en esta p√°gina, no hacemos nada
      if (!tira) return;

      const items = tira.querySelectorAll('.carrusel-item');
      let index = 0;
      const totalFotos = items.length;

      // Limpiamos cualquier temporizador previo para evitar velocidad doble
      if (window.miIntervalo) clearInterval(window.miIntervalo);

      console.log("Iniciando carrusel con " + totalFotos + " fotos.");

      // Solo activamos si hay m√°s de 1 foto
      if (totalFotos > 1) {
        window.miIntervalo = setInterval(() => {
          index++;
          
          // Si llegamos a la √∫ltima, volvemos a la primera (0)
          if (index >= totalFotos) {
            index = 0;
          }
          
          // Movemos la tira hacia la izquierda
          tira.style.transform = `translateX(-${index * 100}%)`;
          
        }, 3000); // Cambia cada 3 segundos
      }
    }

    // Ejecutamos al cargar (Funciona con Turbo y recarga normal)
    document.addEventListener("turbo:load", iniciarCarrusel);
    document.addEventListener("DOMContentLoaded", iniciarCarrusel);
  </script>

<% else %>

  <div style="text-align: center; margin-top: 50px;">
    <%= link_to "Ir a Login / Registro", new_registro_path, style: "background: #333; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; font-size: 1.2em;" %>
  </div>

<% end %>